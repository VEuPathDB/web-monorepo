#!/usr/bin/perl

## unloads user-comment flat file for keyword search to grep through

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use Getopt::Long;
use CBIL::Bio::SequenceUtils;
use DBI;
use ApiCommonWebsite::Model::CommentConfig;

my ($outDir, $prefix, $commentSchema, $debug, $verbose, $projectId);
&GetOptions("outputDir=s" => \$outDir,
            "outputPrefix=s" => \$prefix,
            "projectId=s" => \$projectId,
            "commentSchema=s" => \$commentSchema,
            "verbose!"=> \$verbose,
            "debug!" => \$debug);

if (!$outDir || !$commentSchema){
	die "usage: $0 --projectId <projectId> --outputDir <outputDirectory>"
            . " [--outputPrefix <file-prefix>]"
            . " --commentSchema <commentSchema>"
            . " [--verbose] [--debug]\n";
}

print "options: --outputDir=\"$outDir\" "
      . "outputPrefix=\"$prefix\""
      . "projectId=\"$projectId\""
      . "commentSchema=\"$commentSchema\""
      . "verbose=\$verbose\""
      . "debug=\"$debug\"" if $verbose;

print "Establishing dbi login\n" if $verbose;
my $config = new ApiCommonWebsite::Model::CommentConfig($projectId);

my $dsn = $config->getDbiDsn();
my $login = $config->getLogin();

my $dbh = DBI->connect(
            $config->getDbiDsn, 
            $config->getLogin, 
            $config->getPassword,
            { PrintError => 1, RaiseError => 0}
            ) or die "Can't connect to the database: $DBI::errstr\n";

$dbh->{LongReadLen} = 8192 * 1024;
my $sql;

# comments
$sql = <<SQL;
SELECT '', substr(c.organism, 1, instr(c.organism || '  ', ' ', 1, 2)-1),
       c.stable_id, c.content,
       u.first_name || ' ' || u.last_name || ', ' || u.title || ', ' || u.organization
FROM userlogins.users u, ${commentSchema}.comments c
WHERE u.email(+) = c.email
  AND c.comment_target_id='gene'
  AND c.review_status_id != 'rejected'
  AND project_name = '${projectId}'
  AND c.comment_target_id = 'gene'
ORDER BY substr(c.organism, 1, instr(c.organism || '  ', ' ', 1, 2)-1),
       c.stable_id,
       u.first_name || ' ' || u.last_name || ', ' || u.title || ', ' || u.organization
SQL

&extractFile($dbh, $outDir, "comments.txt", $sql);

sub extractFile {
  my ($dbh, $outDir, $outFile, $sql) = @_;

  print "SQL: $sql\n" if $verbose;

  my $count = 0;
  my $statement = $dbh->prepare($sql);
  $statement->execute();
  my @ids;

  my $tempfile = "${outDir}/keywordQueryFlatfile.$$";

  print "tempfile: $tempfile\n" if $verbose;
  open(OUT,">$tempfile");

  while(my @row = $statement->fetchrow_array()){
    $count++;
    print "Processing record $count\n" if $verbose && $count % 10000 == 0;

    map { s/\s+/ /g } @row;
    print OUT join("\t", @row), " \n";
  }

  $statement->finish();

  close(OUT);
  my $datafile = "${outDir}/${prefix}${outFile}";
  print "renaming $tempfile to $datafile\n" if $verbose;
  rename($tempfile, $datafile);
}
 
